(()=>{"use strict";const t=document.getElementById("user-name"),e=document.getElementById("save-user-name");e.style.display="none";const n=document.querySelector(".todo-list"),o=document.getElementById("todo-main-input"),a=document.querySelector(".todo-block"),c=document.getElementById("del-allbtn");let s,d=[];function i(t){const e=document.createElement("li");e.classList.add("todo-item"),e.dataset.id=t._id;const o=document.createElement("div");o.classList.add("todo-main-text");const a=document.createElement("div");a.classList.add("todo-p"),a.textContent=t.text;const c=document.createElement("div");c.classList.add("todo-name"),c.textContent=t.name;const s=document.createElement("div");s.classList.add("todo-controls");const d=document.createElement("button");d.classList.add("edit-item");const i=document.createElement("input");i.type="checkbox",i.classList.add("done-item"),i.checked=t.completed,t.completed?e.classList.add("check-bg"):e.classList.remove("check-bg");const l=document.createElement("button");l.classList.add("delete-item"),l.textContent="X",e.appendChild(o),e.appendChild(s),o.appendChild(c),o.appendChild(a),s.appendChild(d),s.appendChild(i),s.appendChild(l),n.prepend(e)}function l(){c.style.display=d.length>1?"":"none"}function r(t,e){t.querySelectorAll(".done-item, .delete-item").forEach((t=>{t.style.display=e?"":"none"}))}async function m(){try{const t=await fetch("/tasks");if(!t.ok)throw new Error("Помилка завантаження задач");return await t.json()}catch(t){return console.error("Помилка:",t),[]}}async function u(t){try{await fetch(`/tasks/${t}`,{method:"DELETE"})}catch(t){console.error("Помилка:",t)}}async function p(t,e){try{await fetch(`/tasks/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(t){console.error("Помилка:",t)}}async function y(){try{const t=await m();n.innerHTML="",d=[],t.forEach((t=>{i(t),d.push(t)})),l()}catch(t){console.error("Помилка при оновленні задач:",t)}}function h(){s=setInterval(y,5e3)}document.addEventListener("DOMContentLoaded",(async()=>{let n=localStorage.getItem("userName");n||(n=prompt("Введіть ваше ім'я:"),n&&localStorage.setItem("userName",n)),t.value=n||"",t.addEventListener("focus",(()=>{e.style.display=""})),t.addEventListener("blur",(()=>{setTimeout((()=>{e.style.display="none"}),1e3)})),e.addEventListener("click",(()=>{n=t.value.trim(),n&&(localStorage.setItem("userName",n),alert("Ім'я збережено!"))})),d=await m(),d.forEach((t=>i(t))),l()})),a.addEventListener("click",(({target:t})=>{"add-todo"===t.id?async function(){const t=o.value.trim();if(!t)return void alert("Текст задачі не може бути пустим");const e={name:localStorage.getItem("userName")||"Анонім",text:t,completed:!1},n=await async function(t,e,n=!1){try{const o=await fetch("/tasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,text:e,completed:n})});return await o.json()}catch(t){console.error("Помилка додавання задачі:",t)}}(e.name,e.text,e.completed);n&&n._id&&(d.push(n),i(n),o.value="");l()}():t.classList.contains("delete-item")?async function(t){const e=t.closest(".todo-item"),n=e.dataset.id;if(!n)return;await u(n),d=d.filter((t=>t._id!==n)),e.remove(),l()}(t):t.classList.contains("edit-item")?async function(t){clearInterval(s);const e=t.closest(".todo-item"),n=e.dataset.id;if(!n)return;const o=e.querySelector(".todo-p"),a=o.textContent;r(e,!1);const c=document.createElement("input");c.type="text",c.value=a,c.classList.add("todo-input");const d=document.createElement("button");d.textContent="Save",d.classList.add("save-item");const i=e.querySelector(".todo-main-text");i.replaceChild(c,o),e.appendChild(d),t.style.display="none",d.addEventListener("click",(async()=>{const a=c.value.trim();a?(await p(n,{text:a}),o.textContent=a,i.replaceChild(o,c),d.remove(),t.style.display="",r(e,!0),h()):alert("Текст задачі не може бути пустим")}))}(t):"del-allbtn"===t.id&&async function(){d.forEach((t=>u(t._id))),d=[],n.innerHTML="",l()}()})),o.addEventListener("keydown",(({key:t})=>{"Enter"===t&&document.getElementById("add-todo").click()})),n.addEventListener("change",(({target:t})=>{t.classList.contains("done-item")&&async function(t){const e=t.closest(".todo-item"),n=e.dataset.id;if(!n)return;const o=t.checked;await p(n,{completed:o});d.find((t=>t._id===n)).completed=o,o?e.classList.add("check-bg"):e.classList.remove("check-bg")}(t)})),h()})();